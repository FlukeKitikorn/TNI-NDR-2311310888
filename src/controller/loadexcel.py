import streamlit as st
import pandas as pd

def format_date_thai(dt):
    thai_months = {
        "‡∏°.‡∏Ñ.": "01", "‡∏Å.‡∏û.": "02", "‡∏°‡∏µ.‡∏Ñ.": "03", "‡πÄ‡∏°.‡∏¢.": "04",
        "‡∏û.‡∏Ñ.": "05", "‡∏°‡∏¥.‡∏¢.": "06", "‡∏Å.‡∏Ñ.": "07", "‡∏™.‡∏Ñ.": "08",
        "‡∏Å.‡∏¢.": "09", "‡∏ï.‡∏Ñ.": "10", "‡∏û.‡∏¢.": "11", "‡∏ò.‡∏Ñ.": "12"
    }
    
    # ‡∏Å‡∏£‡∏ì‡∏µ dt ‡πÄ‡∏õ‡πá‡∏ô datetime object (Excel ‡∏≠‡∏≤‡∏à‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô datetime)
    if pd.isnull(dt):
        return None
    
    # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô datetime.datetime ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏£‡∏á ‡πÜ
    if hasattr(dt, "year") and hasattr(dt, "month") and hasattr(dt, "day"):
        year_ad = dt.year
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ñ‡πâ‡∏≤ year > 2500 ‡πÉ‡∏´‡πâ‡∏•‡∏ö 543 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
        if year_ad > 2500:
            year_ad -= 543
        month_num = dt.month
        return f"{year_ad}-{month_num:02d}-{dt.day:02d}"
    
    # ‡∏Å‡∏£‡∏ì‡∏µ dt ‡πÄ‡∏õ‡πá‡∏ô string ‡πÄ‡∏ä‡πà‡∏ô "19 ‡∏û.‡∏Ñ. 2568"
    dt_str = str(dt)
    for th_month, num in thai_months.items():
        if th_month in dt_str:
            # ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô "19 ‡∏û.‡∏Ñ. 2568" ‡∏´‡∏£‡∏∑‡∏≠ "19 ‡∏û.‡∏Ñ. 2568 00:00:00"
            parts = dt_str.split()
            if len(parts) >= 3:
                day = parts[0]
                month = num
                year_th = parts[2]
                year_ad = int(year_th) - 543
                return f"{year_ad}-{month}-{int(day):02d}"
    return None
    
def excel_to_pandas(file):
    try:
        df = pd.read_excel(file, skiprows=1)

        df.columns = [
            "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï ‡πà‡∏≤‡∏™‡∏∏‡∏î", "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î",
            "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á", "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á(%)", "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì(‡∏û‡∏±‡∏ô‡∏´‡∏∏‡πâ‡∏ô)", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤(‡∏•‡πâ‡∏≤‡∏ô‡∏ö‡∏≤‡∏ó)",
            "SET Index", "SET ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á(%)"
        ]

        # ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß header ‡∏ã‡πâ‡∏≥
        df = df[~df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].isna() & ~df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].astype(str).str.contains("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà")]

        # ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö yyyy-mm-dd
        df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"] = df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].apply(format_date_thai)

        # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô datetime ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡πà‡∏≠
        df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"] = pd.to_datetime(df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"], errors='coerce')

        if df.empty:
            st.error("‚ùå DataFrame is empty!")
        return df
    except Exception as e:
        # st.error(f"‚ùå Error processing Excel file: {e}")
        return None
    
def table(file):
    try:
        df = pd.read_excel(file, skiprows=1)
        num_rows, num_cols = df.shape

        df.columns = [
            "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î", "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î",
            "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á", "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á(%)", "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì(‡∏û‡∏±‡∏ô‡∏´‡∏∏‡πâ‡∏ô)", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤(‡∏•‡πâ‡∏≤‡∏ô‡∏ö‡∏≤‡∏ó)",
            "SET Index", "SET ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á(%)"
        ]

        # ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß header ‡∏ã‡πâ‡∏≥
        df = df[~df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].isna() & ~df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].astype(str).str.contains("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà")]

        # ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö yyyy-mm-dd
        df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"] = df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].apply(format_date_thai)

        # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô datetime ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡πà‡∏≠
        df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"] = pd.to_datetime(df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"], errors='coerce')

        if df.empty:
            st.error("‚ùå DataFrame is empty!")
        else:
            st.dataframe(df) 
            st.info(f"üì¶ DataFrame ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {num_rows:,} ‡πÅ‡∏ñ‡∏ß ‡πÅ‡∏•‡∏∞ {num_cols:,} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå")

    except Exception as e:
        # st.error(f"‚ùå Error processing Excel file: {e}")
        return None